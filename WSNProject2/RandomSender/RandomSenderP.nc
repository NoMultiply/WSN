
#include "Calculate.h"

module RandomSenderP
{
	uses interface Boot;
	uses interface Leds;
	uses interface Packet;
	uses interface AMPacket;
	uses interface AMSend;
	uses interface SplitControl;
	uses interface Timer<TMilli> as Timer0;
	uses interface Random;
	uses interface ParameterInit<uint16_t> as SeedInit;
	uses interface Read<uint16_t>;
}
implementation
{
	event void Boot.booted()
	{
		while(SUCCESS != call Read.read())
			;
	}

	event void Read.readDone(error_t result, uint16_t data)
	{
		call SeedInit.init(data);
		while(SUCCESS != call SplitControl.start())
			;
	}

	event void SplitControl.startDone(error_t err)
	{
		if(err != SUCCESS)
			call SplitControl.start();
		else
			call Timer0.startPeriodic(10);
	}

	event void SplitControl.stopDone(error_t err) { }

	message_t queue[12];
	int qh = 0, qt = 0;

	void queue_in(data_packge* dp)
	{
		if((qh+1)%12 == qt)
			return;
		memcpy(
			call Packet.getPayload(&queue[qh], sizeof(data_packge))
			, dp, sizeof(data_packge));
		qh = (qh+1)%12;
	}

	task void senddp()
	{
		if(SUCCESS != call
			AMSend.send(AM_BROADCAST_ADDR, &queue[qt], sizeof(data_packge))
			)
			post senddp();
	}

	uint16_t count = 0;
	uint32_t nums[2000] = {
		1899, 77, 3342, 1672, 4937, 1771, 2193, 4088, 1680, 3837, 3457, 4246, 209, 193, 867, 2663, 3726, 1871, 3625, 1194, 399, 2000, 3755, 1137, 4217, 442, 351, 726, 1110, 4637, 1426, 1836, 609, 635, 767, 1169, 1933, 1496, 1292, 2704, 2040, 9, 1883, 644, 538, 2748, 455, 3260, 75, 1790, 3175, 4280, 4393, 4270, 664, 3065, 873, 2053, 1149, 1146, 4397, 4922, 1239, 85, 462, 214, 1205, 4682, 1760, 4069, 455, 2419, 2438, 3917, 3437, 1365, 4384, 317, 1154, 960, 3096, 1316, 3560, 328, 4798, 4597, 4369, 2471, 903, 1662, 2584, 4660, 120, 3012, 309, 809, 2551, 2093, 4677, 2262, 2598, 4320, 1, 2047, 2341, 470, 2451, 3927, 115, 4301, 3796, 4273, 498, 2940, 1447, 403, 2009, 4412, 4257, 3024, 1183, 945, 1026, 2173, 1190, 72, 823, 3382, 3560, 3932, 4464, 3214, 3004, 229, 2147, 4716, 2548, 2571, 514, 4228, 1459, 3159, 2625, 4697, 2281, 4133, 2081, 1187, 329, 4950, 261, 1834, 2632, 2303, 3528, 268, 1252, 311, 2726, 2596, 490, 557, 1409, 1559, 1577, 682, 4612, 1027, 438, 268, 4015, 3155, 4029, 184, 3841, 2207, 1729, 2346, 3352, 30, 1087, 3094, 2230, 477, 3703, 661, 3853, 1839, 4671, 4803, 4737, 3386, 48, 3099, 4748, 3639, 3367, 824, 831, 3329, 2445, 179, 2338, 2371, 1743, 1505, 2739, 771, 2505, 2170, 2119, 17, 4500, 458, 2563, 3147, 3527, 887, 3762, 4225, 4283, 4657, 4137, 4902, 2048, 3063, 4848, 1022, 3550, 354, 4849, 3376, 2205, 1506, 3926, 1840, 447, 3272, 1359, 4343, 4085, 4104, 3666, 301, 1606, 1665, 3541, 3507, 1235, 1840, 3433, 3747, 3753, 2026, 1378, 4215, 1867, 1770, 2155, 4403, 2393, 3276, 4219, 4057, 4118, 540, 2077, 1768, 718, 2394, 4306, 3272, 896, 4846, 996, 123, 1480, 2275, 11, 3468, 4265, 4918, 1754, 3709, 90, 2489, 3041, 1053, 3763, 4934, 620, 1777, 2741, 3575, 3541, 1586, 3451, 3078, 4618, 2104, 203, 711, 775, 2845, 1573, 1976, 3131, 1843, 3466, 3641, 1432, 1559, 4288, 4728, 2962, 950, 1308, 3306, 2755, 1637, 491, 2461, 4416, 3223, 319, 3090, 1331, 2391, 598, 2204, 2164, 1887, 1969, 4554, 2449, 1360, 2017, 1247, 1561, 1992, 726, 3314, 2143, 4883, 2102, 2523, 1528, 502, 1155, 3288, 4773, 1593, 3486, 1606, 3734, 2388, 1038, 3748, 843, 1875, 2375, 4999, 2723, 4974, 2231, 4275, 831, 3923, 1697, 3173, 4681, 3795, 901, 945, 4664, 3523, 4540, 4033, 2855, 2544, 3356, 2803, 2173, 1911, 2719, 183, 1270, 1181, 743, 1802, 4229, 2793, 4128, 2967, 1651, 4242, 4924, 3373, 4594, 872, 1473, 905, 2314, 4282, 32, 3482, 3935, 4724, 679, 279, 1481, 1774, 2762, 2582, 2972, 4749, 4536, 2414, 1132, 4951, 2274, 1409, 3908, 4645, 2531, 3409, 2144, 1557, 4444, 4750, 1385, 1269, 530, 1829, 3695, 2158, 4863, 1768, 1615, 1661, 1026, 1314, 4693, 4992, 467, 609, 4741, 1904, 1489, 60, 4556, 1734, 4856, 634, 4440, 2036, 3166, 2651, 4359, 3417, 1406, 4685, 4764, 3074, 569, 2715, 525, 4375, 4740, 2188, 3161, 3506, 1244, 3818, 4601, 280, 392, 4751, 2288, 873, 24, 2935, 4710, 3351, 4122, 2262, 1870, 1343, 4400, 290, 1087, 1574, 1614, 873, 3764, 500, 4924, 3211, 1191, 1683, 4704, 4489, 4343, 973, 1523, 1336, 4001, 1327, 3840, 3313, 1621, 2795, 891, 428, 2004, 762, 4117, 2708, 3068, 629, 3429, 4712, 2783, 3108, 4004, 278, 2622, 558, 1594, 2919, 1195, 3663, 4993, 1661, 3425, 2010, 2436, 1443, 1378, 803, 4158, 3010, 4222, 3616, 1112, 2871, 254, 4910, 2723, 411, 1081, 538, 4695, 1002, 1017, 2611, 1519, 1474, 4913, 4710, 1803, 3014, 4752, 1573, 1169, 2555, 3869, 1993, 2602, 3118, 182, 1909, 1804, 4329, 4256, 2841, 4885, 497, 1056, 1859, 1270, 331, 4812, 1638, 989, 1977, 3333, 4122, 4660, 1727, 2703, 4876, 454, 802, 4237, 2975, 2885, 3320, 298, 2863, 1987, 3713, 2998, 1344, 3164, 2206, 1305, 3833, 1433, 4417, 4940, 660, 1172, 3257, 4087, 2356, 3163, 3847, 3024, 779, 4305, 1786, 1973, 3911, 2823, 3818, 2388, 601, 2042, 2408, 3342, 3780, 3458, 1691, 422, 3126, 2548, 977, 37, 3403, 2397, 4247, 4724, 1624, 460, 3879, 4908, 2645, 2603, 3211, 1082, 1015, 2249, 4052, 2594, 2754, 433, 4677, 4843, 2644, 979, 3648, 3577, 4174, 2094, 4532, 164, 3084, 407, 142, 3307, 1722, 827, 309, 1174, 718, 686, 4097, 386, 2830, 4873, 2747, 3876, 3908, 1043, 1237, 1443, 4434, 4306, 183, 1084, 335, 3161, 4590, 2268, 466, 4740, 2733, 2575, 4442, 1946, 4796, 1697, 2422, 896, 1580, 3746, 4063, 4016, 1794, 2015, 385, 3494, 3210, 4579, 1983, 1862, 4765, 900, 4009, 432, 2520, 4323, 2302, 3948, 2433, 4950, 2602, 2342, 3197, 3178, 4155, 2364, 1935, 3219, 2251, 2312, 1739, 3386, 3405, 129, 1975, 3076, 4920, 1032, 3611, 108, 2569, 4, 3630, 2150, 180, 590, 272, 2827, 3621, 3160, 4956, 1545, 1651, 2773, 3996, 2935, 1622, 3989, 4832, 4455, 1338, 3600, 3494, 2883, 2437, 3851, 3430, 4973, 2780, 1830, 4604, 3667, 4581, 4928, 3821, 4207, 4686, 756, 2373, 1574, 1490, 4865, 2477, 4659, 3209, 4764, 4108, 3254, 2277, 3630, 2137, 3123, 4534, 3987, 2346, 1284, 12, 3420, 4270, 3788, 1321, 3483, 510, 299, 4131, 2409, 2828, 103, 4159, 951, 4080, 4326, 18, 3684, 47, 1001, 2430, 2885, 2934, 4515, 4895, 2912, 3578, 135, 1268, 413, 1133, 2106, 2751, 2743, 581, 1965, 3793, 2241, 4640, 1387, 1635, 1148, 4379, 4215, 1115, 821, 3927, 4219, 1751, 4539, 4776, 3857, 4044, 1304, 1110, 2705, 594, 2597, 469, 613, 4957, 3590, 4298, 1893, 3028, 722, 1978, 1471, 2284, 4544, 2017, 1551, 4356, 646, 250, 2766, 3335, 2574, 3681, 4496, 2051, 1002, 435, 2827, 1604, 3276, 4801, 1148, 1553, 4925, 1020, 2813, 2385, 989, 4631, 2062, 580, 3192, 4642, 3085, 1882, 3417, 4127, 4305, 3609, 104, 3095, 4945, 4122, 3196, 3832, 1904, 926, 1634, 4455, 1883, 2813, 3263, 3089, 664, 733, 2352, 4625, 85, 3383, 1107, 4374, 570, 3239, 4497, 1257, 2112, 3284, 3234, 1341, 1631, 645, 3852, 1706, 4069, 2750, 1048, 4101, 4552, 1814, 3647, 2400, 4654, 4173, 1419, 1155, 3773, 5000, 3172, 2283, 1566, 2245, 1467, 3197, 1791, 787, 1145, 1840, 3846, 924, 4781, 2405, 4974, 3878, 2588, 4859, 4413, 32, 1194, 597, 3868, 4436, 2157, 4449, 757, 1730, 4062, 3795, 395, 1353, 2688, 1863, 2719, 565, 2001, 3467, 93, 4509, 2157, 4713, 3403, 2175, 1419, 3477, 3572, 4347, 746, 4167, 666, 3876, 131, 3139, 235, 1215, 3202, 3439, 3582, 451, 3866, 3907, 3467, 4707, 4823, 1678, 4026, 4732, 3233, 3496, 1129, 1915, 514, 2859, 2493, 4385, 4605, 1938, 3629, 4087, 388, 2186, 4084, 3736, 2430, 4803, 4982, 1122, 2262, 1133, 827, 424, 931, 38, 2504, 94, 2442, 1221, 1563, 453, 3137, 1462, 142, 4230, 3659, 4445, 2754, 2128, 625, 2498, 4673, 1687, 4676, 1727, 246, 4431, 4596, 3712, 4794, 1221, 53, 3213, 581, 950, 1160, 255, 4255, 2107, 1318, 1961, 4500, 4154, 3939, 3664, 1705, 496, 3484, 2601, 3291, 4655, 1968, 4940, 1929, 192, 819, 1307, 3686, 1024, 2095, 4354, 683, 2884, 2464, 4727, 2058, 827, 2683, 830, 347, 2277, 3706, 2011, 1559, 1818, 3179, 4928, 3324, 4316, 522, 3899, 4374, 1327, 4624, 493, 2049, 3167, 3158, 4115, 4697, 1657, 110, 2620, 3433, 621, 4023, 2338, 3324, 3222, 4030, 306, 2652, 2310, 2935, 41, 1525, 889, 1321, 2185, 453, 704, 4323, 2205, 883, 2301, 3901, 3564, 4276, 338, 1355, 3594, 1630, 3204, 1678, 2146, 960, 4249, 3967, 4980, 1073, 1877, 3324, 1150, 3972, 665, 3336, 748, 2562, 127, 2155, 31, 3155, 236, 3116, 3962, 2763, 3544, 699, 4419, 1442, 1311, 2576, 424, 2361, 1424, 3741, 557, 3462, 2515, 3982, 64, 2386, 2594, 4134, 3525, 3893, 3816, 1681, 2079, 2907, 4142, 3220, 4170, 1637, 2482, 1327, 4774, 2637, 4688, 3679, 3069, 3120, 4532, 2471, 1725, 3, 1949, 1823, 4429, 4655, 3635, 3587, 4838, 1193, 1003, 3094, 2756, 4624, 3301, 2042, 3075, 4902, 3932, 3911, 198, 814, 4518, 176, 3668, 4999, 3707, 2400, 1325, 3173, 272, 918, 2337, 3045, 620, 2369, 780, 2162, 2814, 4498, 3925, 3449, 4406, 2286, 3452, 2246, 4860, 2588, 3213, 386, 2830, 355, 3218, 2708, 2574, 4095, 2149, 1683, 1503, 292, 3739, 3700, 2143, 423, 3500, 4685, 2113, 1189, 2781, 2952, 4597, 2492, 1151, 4235, 98, 730, 1873, 2281, 4422, 4917, 1540, 3533, 3252, 2513, 4193, 2795, 917, 4183, 4335, 3476, 4161, 1696, 1286, 3720, 2017, 1121, 3282, 1446, 651, 2625, 3819, 3815, 2269, 675, 4315, 1007, 2413, 1231, 522, 1640, 3024, 1182, 1645, 3139, 1362, 2404, 1153, 2971, 2831, 3571, 749, 2579, 458, 4258, 1914, 1907, 1895, 1980, 3254, 4144, 2243, 1570, 806, 1552, 2348, 4505, 1802, 4148, 3675, 4187, 1649, 87, 564, 135, 1356, 3109, 2224, 4787, 555, 2591, 1318, 2971, 2504, 602, 33, 2699, 2612, 581, 794, 284, 68, 3191, 1569, 2794, 2757, 1403, 2504, 3608, 3138, 287, 1230, 200, 63, 973, 4417, 932, 3887, 1924, 3329, 2216, 4258, 1067, 2423, 3694, 2614, 3704, 4924, 4433, 3350, 4487, 3949, 972, 783, 4132, 3538, 1586, 1969, 4944, 538, 3225, 2377, 1669, 2282, 1945, 3530, 279, 1501, 3456, 1615, 2432, 1605, 2283, 4842, 275, 2679, 796, 4745, 601, 26, 391, 3635, 3038, 373, 1865, 1839, 2585, 1005, 1950, 3321, 1177, 4525, 3062, 673, 4836, 1219, 3389, 1896, 332, 866, 20, 1329, 684, 1204, 934, 4773, 782, 1135, 762, 2209, 2948, 3803, 381, 1776, 4879, 2956, 2253, 1505, 936, 4534, 780, 4864, 2454, 2605, 119, 4087, 343, 1660, 587, 413, 809, 3219, 998, 634, 330, 191, 817, 1288, 3807, 3165, 2824, 1055, 4946, 1211, 3181, 863, 3688, 3849, 742, 1446, 4907, 874, 563, 1863, 679, 4306, 4062, 906, 4988, 910, 1986, 4709, 4223, 2424, 4871, 1188, 3489, 575, 941, 701, 1868, 4311, 1717, 1943, 1284, 1440, 3448, 2495, 890, 1950, 4154, 1622, 650, 4676, 4472, 3231, 757, 3082, 3190, 2624, 1222, 191, 2650, 2020, 4464, 1208, 3806, 991, 629, 3903, 2672, 1733, 3334, 3992, 1705, 2432, 4956, 4205, 3296, 4307, 4950, 924, 3500, 642, 65, 875, 93, 1269, 4552, 2827, 685, 3843, 4249, 4531, 4797, 1074, 4387, 4166, 500, 2424, 3405, 2758, 2484, 4634, 789, 3828, 1138, 2768, 3677, 3647, 2452, 3934, 410, 1704, 3983, 165, 1451, 4896, 11, 600, 4710, 1295, 3004, 233, 2425, 850, 4849, 100, 2320, 902, 3738, 3713, 812, 4455, 1656, 197, 2760, 97, 2680, 522, 1168, 1513, 2579, 2903, 3752, 1382, 1656, 1605, 1117, 3240, 2895, 3433, 2542, 3908, 196, 4687, 4166, 936, 1265, 469, 3179, 1408, 4674, 3444, 1868, 379, 1638, 3777, 2229, 956, 1769, 3733, 2306, 2876, 608, 1251, 3078, 2894, 4640, 4036, 2065, 503, 1538, 3201, 4355, 3577, 448, 4672, 280, 643, 3752, 2155, 486, 212, 3102, 3533, 4171, 907, 2530, 1654, 4120, 2274, 3450, 2315, 1368, 681, 2099, 1884, 2381, 676, 2512, 1454, 4649, 2429, 4091, 648, 1939, 4394, 293, 4217, 4574, 3385, 2108, 3651, 1545, 4210, 550, 4124, 1560, 917, 4844, 205, 726, 4338, 2194, 2255, 1937, 43, 4011, 1114, 4343, 4849, 3554, 2162, 1965, 507, 4691, 2167, 4255, 3249, 4601, 4046, 4197, 4784, 1026, 4459, 1507, 586, 2433, 3139, 563, 4566, 4999, 2728, 4959, 934, 330, 4277, 2797, 1254, 4662, 3134, 1700, 3315, 684, 2830, 4685, 4307, 4909, 4385, 4195, 874, 4489, 3886, 4740, 273, 2373, 2890, 4037, 4454, 4126, 476, 1933, 624, 1168, 4427, 1456, 4483, 2638, 3000, 3339, 1533, 263, 1665, 2857, 4542, 3431, 263, 4184, 310, 4699, 1870, 2910, 2687, 1358, 1525, 4359, 371, 457, 4313, 4725, 4229, 1519, 4853, 2123, 3190, 1193, 1143, 3916, 510, 2274, 4856, 154, 4490, 307, 1060, 3098, 3731, 4818, 2895, 4126, 3910, 390, 4474, 92, 3060, 1830, 1937, 1114, 1974, 239, 539, 1268, 3994, 4188, 2697, 3425, 2114, 3986, 3093, 952, 2535, 262, 3560, 1329, 2476, 3028, 3761, 3046, 4640, 2424, 3613, 2405, 1155, 2612, 2294, 59, 4400, 2923, 874, 888, 3950, 4800, 2237, 61, 1857, 3704, 128, 4089, 3206, 64, 2096, 4165, 3045, 2737, 3005, 1841, 3475, 805, 2324, 2937, 2038, 2445, 1206, 1785, 1590, 1120, 2188, 2375, 2939, 1926, 3111, 4068, 40, 3992, 1640, 2640, 4457, 4595, 3007, 509, 2538, 3469, 3335, 4280, 205, 481, 3738, 3929, 2946, 2325, 2783, 3107, 1004, 1087, 4934, 410, 4309, 3212, 494, 1307, 1164, 1011, 1449, 4155, 3467, 1006, 2339, 3011, 3581, 556, 2808, 1551, 1092, 3958, 3330, 3909, 2330, 3201, 4490, 278, 4958, 388, 2533, 1977, 3733, 785, 2145, 455, 1703, 258, 706, 4888, 3680, 4475, 4288, 2856, 3417, 1689, 3221, 2143, 2137, 2202, 334, 3218, 4967, 3218, 3043, 1181, 1640, 2938, 1759, 3065, 171, 4939, 2335, 2989, 4843, 3988, 4716, 2888, 2454
	};
	uint32_t seed = 1;

	event void Timer0.fired()
	{
		data_packge dp;
		dp.sequence_number = count%2000 + 1;
        //send from 1 ... 2000
		/*if(count < 2000)
		{
			nums[count] = seed % 5000;
			seed = seed + 1;
		}*/
		dp.random_integer = nums[count%2000];
		queue_in(&dp);
		post senddp();
		count++;
		if(count%100 == 0)
			call Leds.led0Toggle();
		if(count % 2000 == 0)
			call Leds.led1Toggle();
	}

	event void AMSend.sendDone(message_t* msg, error_t err)
	{
		if(msg == &queue[qt] && err == SUCCESS)
			qt = (qt+1)%12;
		if(qt != qh)
			post senddp();
	}
}
